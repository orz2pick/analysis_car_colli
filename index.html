<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>è¡Œè½¦è®°å½•ä»ªå®‰å…¨åˆ†æ</title>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/coco-ssd@latest"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            touch-action: manipulation;
        }
        
        body {
            background: #0a0a0a;
            color: #fff;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            overflow-x: hidden;
        }

        .container {
            max-width: 100%;
            padding: 10px;
        }

        /* ä¸Šä¼ åŒºåŸŸ */
        .upload-zone {
            border: 2px dashed #444;
            border-radius: 12px;
            padding: 40px 20px;
            text-align: center;
            margin-bottom: 20px;
            background: #1a1a1a;
            transition: all 0.3s;
        }

        .upload-zone.active {
            border-color: #00ff88;
            background: #0f2a1f;
        }

        input[type="file"] {
            display: none;
        }

        .btn {
            background: #007AFF;
            color: white;
            padding: 12px 24px;
            border-radius: 8px;
            border: none;
            font-size: 16px;
            cursor: pointer;
            display: inline-block;
            margin: 5px;
            transition: transform 0.1s;
        }

        .btn:active {
            transform: scale(0.95);
        }

        .btn:disabled {
            background: #444;
            cursor: not-allowed;
        }

        .btn-secondary {
            background: #34C759;
        }

        /* è§†é¢‘åŒºåŸŸ */
        .video-container {
            position: relative;
            width: 100%;
            background: #000;
            border-radius: 8px;
            overflow: hidden;
            display: none;
            margin-bottom: 20px;
        }

        .video-container.active {
            display: block;
        }

        video {
            width: 100%;
            height: auto;
            display: block;
        }

        #overlayCanvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
        }

        /* æ—¶é—´è½´åŒºåŸŸ */
        .timeline-container {
            background: #1a1a1a;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 20px;
            display: none;
        }

        .timeline-container.active {
            display: block;
        }

        .timeline-label {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            font-size: 14px;
            color: #888;
        }

        #timelineCanvas {
            width: 100%;
            height: 60px;
            background: #2a2a2a;
            border-radius: 8px;
            cursor: pointer;
            touch-action: none;
        }

        .legend {
            display: flex;
            gap: 20px;
            margin-top: 10px;
            font-size: 12px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .dot {
            width: 12px;
            height: 12px;
            border-radius: 2px;
        }

        .dot.safe { background: #34C759; }
        .dot.danger { background: #FF3B30; }

        /* çŠ¶æ€æ  */
        .status-bar {
            background: #1a1a1a;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            font-size: 14px;
            display: none;
        }

        .status-bar.active {
            display: block;
        }

        .progress-bar {
            width: 100%;
            height: 6px;
            background: #333;
            border-radius: 3px;
            margin-top: 10px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: #007AFF;
            width: 0%;
            transition: width 0.3s;
        }

        /* å½“å‰æ—¶é—´ä¿¡æ¯ */
        .time-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 10px;
            font-size: 18px;
            font-weight: bold;
        }

        .ttc-display {
            font-size: 24px;
            color: #34C759;
        }

        .ttc-display.danger {
            color: #FF3B30;
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.6; }
        }

        /* æ§åˆ¶æŒ‰é’® */
        .controls {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 15px;
        }

        .play-btn {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: #fff;
            color: #000;
            border: none;
            font-size: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }

        /* æç¤ºæ–‡å­— */
        .tips {
            color: #666;
            font-size: 12px;
            margin-top: 10px;
            line-height: 1.5;
        }
    </style>
</head>
<body>
    <div class="container">
        <h2 style="text-align: center; margin: 20px 0; font-size: 20px;">ğŸš— è¡Œè½¦å®‰å…¨åˆ†æç³»ç»Ÿ</h2>

        <!-- ä¸Šä¼ åŒºåŸŸ -->
        <div class="upload-zone" id="uploadZone">
            <div style="font-size: 48px; margin-bottom: 10px;">ğŸ“¹</div>
            <div style="margin-bottom: 15px; color: #aaa;">ç‚¹å‡»ä¸Šä¼ è¡Œè½¦è®°å½•ä»ªè§†é¢‘</div>
            <button class="btn" onclick="document.getElementById('fileInput').click()">é€‰æ‹©è§†é¢‘æ–‡ä»¶</button>
            <input type="file" id="fileInput" accept="video/*">
            <div class="tips">
                æ”¯æŒ MP4/MOV æ ¼å¼<br>
                å»ºè®®æ—¶é•¿ï¼š1-5åˆ†é’Ÿï¼ˆåˆ†ææ—¶é—´è¾ƒé•¿è¯·è€å¿ƒç­‰å¾…ï¼‰
            </div>
        </div>

        <!-- çŠ¶æ€æ  -->
        <div class="status-bar" id="statusBar">
            <div id="statusText">å‡†å¤‡åˆ†æ...</div>
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill"></div>
            </div>
            <div style="margin-top: 8px; font-size: 12px; color: #666;">
                <span id="frameInfo">0/0 å¸§</span> | 
                <span id="timeInfo">00:00/00:00</span>
            </div>
        </div>

        <!-- è§†é¢‘æ’­æ”¾åŒºåŸŸ -->
        <div class="video-container" id="videoContainer">
            <video id="video" playsinline></video>
            <canvas id="overlayCanvas"></canvas>
        </div>

        <!-- æ—¶é—´è½´ -->
        <div class="timeline-container" id="timelineContainer">
            <div class="timeline-label">
                <span>00:00</span>
                <span id="durationLabel">00:00</span>
            </div>
            <canvas id="timelineCanvas"></canvas>
            <div class="legend">
                <div class="legend-item">
                    <div class="dot safe"></div>
                    <span>å®‰å…¨ (>3ç§’)</span>
                </div>
                <div class="legend-item">
                    <div class="dot danger"></div>
                    <span>å±é™© (<3ç§’)</span>
                </div>
            </div>
            
            <div class="time-info">
                <span id="currentTime">00:00</span>
                <div class="ttc-display" id="ttcDisplay">-- ç§’</div>
            </div>

            <div class="controls">
                <button class="play-btn" id="playBtn">â–¶</button>
            </div>
        </div>
    </div>

    <script>
        // å…¨å±€å˜é‡
        let model = null;
        let video = document.getElementById('video');
        let overlayCanvas = document.getElementById('overlayCanvas');
        let overlayCtx = overlayCanvas.getContext('2d');
        let timelineCanvas = document.getElementById('timelineCanvas');
        let timelineCtx = timelineCanvas.getContext('2d');
        
        let analysisData = []; // å­˜å‚¨åˆ†æç»“æœ [{time, ttc, isDanger, boxes}]
        let isAnalyzing = false;
        let isDragging = false;
        
        // é…ç½®
        const CONFIG = {
            SAMPLE_INTERVAL: 0.2, // æ¯0.2ç§’åˆ†æä¸€å¸§
            WARNING_THRESHOLD: 3.0,
            TRACKING_RANGE: 50
        };

        // åˆå§‹åŒ–æ¨¡å‹
        async function initModel() {
            if (model) return;
            updateStatus('æ­£åœ¨åŠ è½½ AI æ¨¡å‹...', 10);
            model = await cocoSsd.load({ base: 'lite_mobilenet_v2' });
            updateStatus('æ¨¡å‹åŠ è½½å®Œæˆ', 100);
        }

        // æ–‡ä»¶ä¸Šä¼ å¤„ç†
        document.getElementById('fileInput').addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;
            
            await initModel();
            
            const url = URL.createObjectURL(file);
            video.src = url;
            
            video.onloadedmetadata = () => {
                document.getElementById('uploadZone').style.display = 'none';
                document.getElementById('statusBar').classList.add('active');
                document.getElementById('videoContainer').classList.add('active');
                
                // è®¾ç½®ç”»å¸ƒå°ºå¯¸
                overlayCanvas.width = video.videoWidth;
                overlayCanvas.height = video.videoHeight;
                
                startAnalysis();
            };
        });

        // åˆ†æè§†é¢‘
        async function startAnalysis() {
            isAnalyzing = true;
            analysisData = [];
            video.pause();
            
            const duration = video.duration;
            const totalFrames = Math.floor(duration / CONFIG.SAMPLE_INTERVAL);
            let currentFrame = 0;
            
            // é€å¸§åˆ†æ
            for (let time = 0; time < duration; time += CONFIG.SAMPLE_INTERVAL) {
                if (!isAnalyzing) break;
                
                video.currentTime = time;
                await new Promise(resolve => {
                    video.onseeked = resolve;
                });
                
                // ç­‰å¾…ä¸€å°ä¼šå„¿ç¡®ä¿å¸§å·²æ¸²æŸ“
                await new Promise(r => setTimeout(r, 50));
                
                // æ£€æµ‹
                const predictions = await model.detect(video);
                const cars = predictions.filter(p => 
                    p.class === 'car' || p.class === 'truck' || p.class === 'bus'
                );
                
                // è®¡ç®—TTCï¼ˆç®€åŒ–ç‰ˆï¼šåŸºäºè½¦æ¡†é«˜åº¦ä¼°ç®—ï¼‰
                let minTTC = Infinity;
                let isDanger = false;
                let processedBoxes = [];
                
                if (cars.length > 0) {
                    // æ‰¾æœ€ä¸‹æ–¹çš„ä¸‹æ–¹çš„è½¦ï¼ˆæœ€è¿‘çš„è½¦ï¼‰
                    const closestCar = cars.sort((a, b) => 
                        (a.bbox[1] + a.bbox[3]) - (b.bbox[1] + b.bbox[3])
                    )[0];
                    
                    const height = closestCar.bbox[3];
                    const yPos = closestCar.bbox[1] + height;
                    
                    // ç®€å•çš„é€è§†ä¼°ç®—ï¼šè½¦æ¡†è¶Šå¤§è¶Šè¿‘
                    // å‡è®¾æ»¡å±é«˜åº¦å¯¹åº” 2 ç§’ï¼ŒåŠå±å¯¹åº” 5 ç§’ï¼ˆéœ€è¦æ ¹æ®å®é™…æ ‡å®šï¼‰
                    const estimatedTTC = Math.max(0.5, (video.videoHeight * 0.8) / height * 1.5);
                    
                    // æ£€æŸ¥æ˜¯å¦åœ¨ä¸­é—´è½¦é“ï¼ˆç®€åŒ–åˆ¤æ–­ï¼‰
                    const centerX = closestCar.bbox[0] + closestCar.bbox[2]/2;
                    const isCenter = Math.abs(centerX - video.videoWidth/2) < video.videoWidth * 0.4;
                    
                    minTTC = isCenter ? estimatedTTC : Infinity;
                    isDanger = minTTC < CONFIG.WARNING_THRESHOLD;
                    
                    processedBoxes = cars.map(c => ({
                        bbox: c.bbox,
                        isCenter: Math.abs((c.bbox[0] + c.bbox[2]/2) - video.videoWidth/2) < video.videoWidth * 0.4,
                        ttc: (video.videoHeight * 0.8) / c.bbox[3] * 1.5
                    }));
                }
                
                analysisData.push({
                    time: time,
                    ttc: minTTC === Infinity ? 99 : minTTC,
                    isDanger: isDanger,
                    boxes: processedBoxes
                });
                
                // æ›´æ–°è¿›åº¦
                currentFrame++;
                const progress = (currentFrame / totalFrames) * 100;
                updateStatus(`æ­£åœ¨åˆ†æè§†é¢‘... ${Math.round(progress)}%`, progress);
                document.getElementById('frameInfo').textContent = `${currentFrame}/${totalFrames} å¸§`;
                document.getElementById('timeInfo').textContent = 
                    `${formatTime(time)}/${formatTime(duration)}`;
            }
            
            isAnalyzing = false;
            updateStatus('åˆ†æå®Œæˆ', 100);
            
            // æ˜¾ç¤ºæ—¶é—´è½´
            document.getElementById('timelineContainer').classList.add('active');
            document.getElementById('durationLabel').textContent = formatTime(duration);
            
            // åˆå§‹åŒ–æ—¶é—´è½´ç”»å¸ƒ
            timelineCanvas.width = timelineCanvas.offsetWidth;
            timelineCanvas.height = timelineCanvas.offsetHeight;
            
            drawTimeline();
            setupTimelineInteraction();
            
            // å›åˆ°å¼€å¤´
            video.currentTime = 0;
            renderFrame(0);
        }

        // ç»˜åˆ¶æ—¶é—´è½´
        function drawTimeline() {
            const ctx = timelineCtx;
            const width = timelineCanvas.width;
            const height = timelineCanvas.height;
            const duration = video.duration;
            
            ctx.clearRect(0, 0, width, height);
            
            // ç»˜åˆ¶èƒŒæ™¯
            ctx.fillStyle = '#333';
            ctx.fillRect(0, 0, width, height);
            
            // ç»˜åˆ¶å®‰å…¨/å±é™©æ®µ
            analysisData.forEach((data, index) => {
                const x = (data.time / duration) * width;
                const nextX = index < analysisData.length - 1 ? 
                    (analysisData[index + 1].time / duration) * width : x + 2;
                
                ctx.fillStyle = data.isDanger ? '#FF3B30' : '#34C759';
                ctx.fillRect(x, 0, nextX - x, height);
            });
            
            // ç»˜åˆ¶å½“å‰ä½ç½®çº¿
            drawPlayhead();
        }

        // ç»˜åˆ¶æ’­æ”¾å¤´
        function drawPlayhead() {
            const width = timelineCanvas.width;
            const height = timelineCanvas.height;
            const duration = video.duration;
            const x = (video.currentTime / duration) * width;
            
            // æ¸…é™¤ä¹‹å‰çš„æ’­æ”¾å¤´ï¼ˆé‡ç»˜èƒŒæ™¯æ¡ï¼‰
            drawTimelineBase();
            
            // ç”»çº¿
            ctx.strokeStyle = '#fff';
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.moveTo(x, 0);
            ctx.lineTo(x, height);
            ctx.stroke();
            
            // ç”»å¤´éƒ¨åœ†ç‚¹
            ctx.fillStyle = '#fff';
            ctx.beginPath();
            ctx.arc(x, height/2, 6, 0, Math.PI * 2);
            ctx.fill();
        }

        let ctx = timelineCtx; // ç®€å†™

        function drawTimelineBase() {
            const width = timelineCanvas.width;
            const height = timelineCanvas.height;
            const duration = video.duration;
            
            ctx.clearRect(0, 0, width, height);
            
            // é‡ç»˜çº¢ç»¿æ¡
            analysisData.forEach((data, index) => {
                const x = (data.time / duration) * width;
                const nextX = index < analysisData.length - 1 ? 
                    (analysisData[index + 1].time / duration) * width : x + 2;
                
                ctx.fillStyle = data.isDanger ? '#FF3B30' : '#34C759';
                ctx.fillRect(x, 4, Math.max(nextX - x, 1), height - 8);
            });
        }

        // æ—¶é—´è½´äº¤äº’
        function setupTimelineInteraction() {
            const canvas = timelineCanvas;
            
            const handleInteraction = (e) => {
                const rect = canvas.getBoundingClientRect();
                const clientX = e.touches ? e.touches[0].clientX : e.clientX;
                const x = clientX - rect.left;
                const ratio = Math.max(0, Math.min(1, x / rect.width));
                const time = ratio * video.duration;
                
                video.currentTime = time;
                renderFrame(time);
                updateTimeDisplay(time);
            };
            
            canvas.addEventListener('mousedown', (e) => {
                isDragging = true;
                handleInteraction(e);
            });
            
            canvas.addEventListener('mousemove', (e) => {
                if (isDragging) handleInteraction(e);
            });
            
            canvas.addEventListener('mouseup', () => isDragging = false);
            canvas.addEventListener('mouseleave', () => isDragging = false);
            
            // è§¦æ‘¸æ”¯æŒ
            canvas.addEventListener('touchstart', (e) => {
                isDragging = true;
                handleInteraction(e);
                e.preventDefault();
            });
            
            canvas.addEventListener('touchmove', (e) => {
                if (isDragging) {
                    handleInteraction(e);
                    e.preventDefault();
                }
            });
            
            canvas.addEventListener('touchend', () => isDragging = false);
        }

        // æ¸²æŸ“æŒ‡å®šæ—¶é—´çš„å¸§ï¼ˆç”»æ¡†ï¼‰
        function renderFrame(time) {
            // æ‰¾åˆ°æœ€è¿‘çš„æ•°æ®ç‚¹
            const data = analysisData.reduce((prev, curr) => {
                return Math.abs(curr.time - time) < Math.abs(prev.time - time) ? curr : prev;
            });
            
            if (!data) return;
            
            // æ¸…ç©ºç”»å¸ƒ
            overlayCtx.clearRect(0, 0, overlayCanvas.width, overlayCanvas.height);
            
            // ç»˜åˆ¶æ£€æµ‹æ¡†
            data.boxes.forEach(box => {
                const [x, y, w, h] = box.bbox;
                const isDanger = box.isCenter && box.ttc < CONFIG.WARNING_THRESHOLD;
                
                overlayCtx.strokeStyle = isDanger ? '#FF3B30' : '#00ff00';
                overlayCtx.lineWidth = isDanger ? 4 : 2;
                overlayCtx.strokeRect(x, y, w, h);
                
                // ç”»æ ‡ç­¾
                overlayCtx.fillStyle = isDanger ? '#FF3B30' : '#00ff00';
                overlayCtx.font = 'bold 16px Arial';
                const text = isDanger ? `å±é™© ${box.ttc.toFixed(1)}s` : `${box.ttc.toFixed(1)}s`;
                overlayCtx.fillText(text, x, y - 5);
                
                // å¦‚æœæ˜¯å±é™©ï¼Œç”»é—ªçƒæ•ˆæœ
                if (isDanger) {
                    overlayCtx.strokeStyle = 'rgba(255, 59, 48, 0.3)';
                    overlayCtx.lineWidth = 8;
                    overlayCtx.strokeRect(x-4, y-4, w+8, h+8);
                }
            });
            
            // æ›´æ–°TTCæ˜¾ç¤º
            const ttcDisplay = document.getElementById('ttcDisplay');
            if (data.isDanger) {
                ttcDisplay.textContent = data.ttc.toFixed(1) + ' ç§’';
                ttcDisplay.classList.add('danger');
            } else {
                ttcDisplay.textContent = data.ttc > 50 ? 'å®‰å…¨' : data.ttc.toFixed(1) + ' ç§’';
                ttcDisplay.classList.remove('danger');
            }
        }

        // æ’­æ”¾æ§åˆ¶
        const playBtn = document.getElementById('playBtn');
        playBtn.addEventListener('click', () => {
            if (video.paused) {
                video.play();
                playBtn.textContent = 'â¸';
            } else {
                video.pause();
                playBtn.textContent = 'â–¶';
            }
        });

        video.addEventListener('timeupdate', () => {
            if (!isDragging) {
                renderFrame(video.currentTime);
                updateTimeDisplay(video.currentTime);
                drawPlayhead();
            }
        });

        video.addEventListener('ended', () => {
            playBtn.textContent = 'â–¶';
        });

        // å·¥å…·å‡½æ•°
        function updateStatus(text, percent) {
            document.getElementById('statusText').textContent = text;
            document.getElementById('progressFill').style.width = percent + '%';
        }

        function updateTimeDisplay(time) {
            document.getElementById('currentTime').textContent = formatTime(time);
        }

        function formatTime(seconds) {
            const m = Math.floor(seconds / 60);
            const s = Math.floor(seconds % 60);
            return `${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;
        }

        // å“åº”å¼è°ƒæ•´
        window.addEventListener('resize', () => {
            if (analysisData.length > 0) {
                timelineCanvas.width = timelineCanvas.offsetWidth;
                drawTimeline();
            }
        });
    </script>
</body>
</html>
